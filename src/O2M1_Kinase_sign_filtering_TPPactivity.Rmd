---
title: "O2M1: Script to implement kinase sign filtering and do a TPP activity estimation"
output:
  html_document:
    keep_md: yes
    toc: yes
    theme: united
    code_folding: hide
---

# General settings

## Set options

```{r setup}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  include = TRUE,
  cache = TRUE,
  cache.lazy = FALSE,
  eval = TRUE,
  tidy = TRUE,
  fig.width = 8 * (1 + sqrt(5)) / 2, fig.height = 8 # golden ratio
)

knitr::opts_knit$set(root.dir = "C:/Users/mb923573/Documents/Master_thesis/O2_Network_modeling/")
```

## Load packages

```{r, message=F, warning =F}
library(tidyverse) # ggplot2, purrr, tibble, dplyr, tidyr, stringr, readr, forcats
library("reshape2")
library(OmnipathR)
library(xlsx)
library(viridis)
library(ggrepel)
library(org.Hs.eg.db)
library(knitr)
library(ggpubr)
```

## Load data

```{r, cache = F}
load("data/KSN.RData")
load("data/310521_PKNcollection.RData")

load("data/210626_DEmultiomics_Olaparib_gathered_updated")
load("data/210802_limma_UWB1.289_initialdataset_correctedphospho_Ola.RData")
load("data/210826_limma_T47D_correctedphospho_Ola.RData")

load("data/210902_viper_footprints.RData")
# load("data/210626_empiricalzscore_footprints.RData")
```

**ATTENTION! Here individual datasets must be specified**

Example shown for multiple TPP sets of the UWB cell line. Can also be done for individual sets. Result objects are set specific.

```{r}
# set the TPP scores for which the correction will take place

# load("data/210902_allTPPscores_T47D.RData")
# load("data/2021_09_10_TPPscores_Fstatmono_T47D_without30uM.RData")
load("data/210825_allTPPscores.RData")
TPP_all_scores <- TPP_all_scores # TPP_Fstatmono_without30uM_T47D
```

Specifiy corresponding phospho dataset

```{r, cache = F}
limma <- limma_UWB1.289_initialdataset_correctedphospho

# set conditions to filter limma results accordingly
condition <- "BRCA_nul_24h_4"
condition_long <- "UWB1.289_BRCA1_24h_4uM"
```

SET SAVE ID! Output has to be saved to run COSMOS

```{r}
saveID <- paste(gsub(" |-|:", "_", Sys.time()), "COSMOSinput_UWB", sep = "_")
```

# Data preparation

## Prior knowledge

Get priorÃŸknowledge links of kinases-phophatases and corresponding phosphosites.

```{r}
KSN$substrate_protein <- sub("_.*$", "", KSN$substrate_genesymbol)
```

Old phospho data (uncorrected)

```{r}
# ttop_RNA <- phospho_ola %>%
#   mutate(condition_long = str_replace(condition_long, "04uM", "0.4uM")) %>%
#   mutate(aa=str_extract(psite, "[[:upper:]]")) %>%
#   mutate(pos=as.numeric(str_extract(psite, "\\d{1,4}"))) %>%
#   #correct -1 bug in the input data
#   #mutate(pos1= ifelse(cell_line != "T47D", as.character(pos-1), pos)) %>%
#   mutate(ID_cosmos=paste(GeneSymbol, "_", aa, pos, sep=""))%>%
#   dplyr::select(ID_cosmos, logFC, t, condition_long) %>%
#   filter(!is.na(logFC) & !is.na(ID_cosmos)) %>%
#   mutate(ID_cosmos = gsub(",.+$", "", ID_cosmos)) %>%
#   mutate(condition_long = gsub("uM", "", condition_long),
#          condition_long = paste0(condition_long, "_Olaparib")) %>%
#   filter(condition_long == "UWB1.289_24h_4_Olaparib")
```

Old regulators

```{r}
# phosphoproteomic_regulators <- empiricalzscore_act_phosphoproteomics %>%
#   filter(sample == "UWB1.289_24h_4uM" & abs(zscore) > 0.5)
#
# if (nrow(phosphoproteomic_regulators) < 20) {
#   phosphoproteomic_regulators <- empiricalzscore_act_phosphoproteomics %>%
#   filter(sample == "UWB1.289_24h_4uM") %>%
#   group_by(sample) %>%
#   top_n(wt = abs(score), n = 20)
# }
#
# Kinases_input_COSMOS <- sign(phosphoproteomic_regulators$score)
# names(Kinases_input_COSMOS) <- paste0("X",
#   mapIds(org.Hs.eg.db, phosphoproteomic_regulators$protein, 'ENTREZID', 'SYMBOL'))
# Kinases_input_COSMOS <- Kinases_input_COSMOS[names(Kinases_input_COSMOS)!="XNA"]
```

## Corrected phosphosignal

Foramt phosphoprotoemics data after intensitz correction

```{r}
psites <- limma %>%
  filter(condition == condition) %>%
  filter(comparison == "Ola") %>%
  mutate(
    gene_name = mapIds(org.Hs.eg.db, representative, "SYMBOL", "UNIPROT"),
    condition_long = paste(condition, comparison, sep = "_"),
    UP = representative,
    GeneSymbol = gene_name,
    aa = str_extract(psite, "[[:upper:]]"),
    pos = as.numeric(str_extract(psite, "\\d{1,4}"))
  ) %>%
  mutate(ID_cosmos = paste(GeneSymbol, "_", aa, pos, sep = "")) %>%
  dplyr::select(ID_cosmos, logFC, t, condition_long) %>%
  filter(!is.na(logFC) & !is.na(ID_cosmos)) %>%
  mutate(ID_cosmos = gsub(",.+$", "", ID_cosmos))
```

## Phosphoproteomic footprinting results

Format footprinitng results and prepare for end onject which is exported for runCOSMOS.

```{r}
phosphoproteomic_regulators_filtered <- viperRes_phospho_corrected %>%
  filter(condition_long == condition_long) %>%
  top_n(30, wt = absNES)


Kinases_input_COSMOS <- sign(phosphoproteomic_regulators_filtered$NES)
names(Kinases_input_COSMOS) <- paste0(
  "X",
  mapIds(org.Hs.eg.db, phosphoproteomic_regulators_filtered$regulator, "ENTREZID", "SYMBOL")
)
Kinases_input_COSMOS <- Kinases_input_COSMOS[names(Kinases_input_COSMOS) != "XNA"]
```

## TPP hits

Get TPP hits and aggregeate a high confidence set with proteins found in more than 3 hit sets.

```{r}
TPP_hits_highcoverage <- TPP_all_scores %>%
  group_by(representative) %>%
  mutate(number_strategies = n()) %>%
  filter(number_strategies >= 3) %>%
  distinct(representative, .keep_all = T) %>%
  mutate(signed_score = ifelse(mode == "destabilized" | mode == "decreased abundance", -1, 1))

TPP_all_scores <- TPP_all_scores %>%
  group_by(representative) %>%
  mutate(number_strategies = n()) %>%
  # filter(number_strategies >= 3) %>%
  # distinct(representative, .keep_all = T) %>%
  mutate(signed_score = ifelse(mode == "destabilized" | mode == "decreased abundance", -1, 1))
```

# Combine prior knowledge, phosphorylation and TPP

Perform the kinase sign filtering to remove links btw kianses and TPP proteins

```{r}
kinase_targets <- TPP_all_scores[TPP_all_scores$gene_name %in% KSN$substrate_protein, ]
kinase_targets$cosmosID <- paste0("X", mapIds(org.Hs.eg.db, kinase_targets$gene_name, "ENTREZID", "SYMBOL"))


KSN_withFCs <- KSN %>%
  left_join(psites, by = c("substrate_genesymbol" = "ID_cosmos")) %>%
  dplyr::select(-condition_long)

KSN_TPPtargets <- KSN_withFCs %>%
  filter(substrate_protein %in% kinase_targets$gene_name)

KSN_TPPtargets$source_cosmos <- paste0("X", mapIds(org.Hs.eg.db, KSN_TPPtargets$enzyme_genesymbol, "ENTREZID", "SYMBOL"))


inputs <- Kinases_input_COSMOS[names(Kinases_input_COSMOS) %in% KSN_TPPtargets$source_cosmos]

KSN_TPPtargets$TF_sign <- sapply(KSN_TPPtargets$source_cosmos, function(x, inputs) {
  if (x %in% names(inputs)) {
    return(as.numeric(inputs[x]))
  } else {
    return(NA)
  }
}, inputs = inputs)

KSN_TPPtargets_filt <- filter(KSN_TPPtargets, !is.na(logFC) & !is.na(TF_sign))
KSN_TPPtargets_filt <- KSN_TPPtargets_filt[is.na(KSN_TPPtargets_filt$TF_sign) | sign(KSN_TPPtargets_filt$logFC * KSN_TPPtargets_filt$sign) != sign(KSN_TPPtargets_filt$TF_sign), ]

KSN_TPPtargets_filt
```

# TPP activities

## from pospho data

```{r}
annoated_ptms <- OmnipathR::get_signed_ptms() %>% filter(is_inhibition + is_stimulation == 1)


annoated_ptms_measured <- annoated_ptms %>%
  filter(enzyme_genesymbol %in% phosphoproteomic_regulators_filtered$regulator &
    substrate_genesymbol %in% TPP_all_scores$gene_name) %>%
  left_join(phosphoproteomic_regulators_filtered, by = c("enzyme_genesymbol" = "regulator")) %>%
  mutate(Kinasesign = sign(NES)) %>%
  dplyr::select(enzyme_genesymbol, substrate_genesymbol, is_inhibition, is_stimulation, Kinasesign) %>%
  mutate(sign = ifelse(is_inhibition == 1, -1, 1) * Kinasesign)

viper_phospho_top <- phosphoproteomic_regulators_filtered
```

## from transcriptomic data

Only a test - no consistnet links between TFs and TPP that can be exploited.

```{r}
# dorothea <- OmnipathR::import_dorothea_interactions()  %>% filter(is_inhibition + is_stimulation==1)
#
# viper_trans_top <- viperRes_trans %>%
#   filter(condition_long == condition) %>%
#   top_n(30, wt = absNES)
#
# dorothea_measured <- dorothea %>% filter(source_genesymbol %in% viper_trans_top$regulator &
#                                                      target_genesymbol %in% TPP_all_scores$gene_name) %>%
#   left_join(viper_trans_top, by = c("source_genesymbol" = "regulator")) %>%
#   mutate(TFsign = sign(NES))%>%
#   dplyr::select(source_genesymbol, target_genesymbol, is_inhibition, is_stimulation, TFsign) %>%
#   mutate(sign = ifelse(is_inhibition == 1, -1, 1)*TFsign)
```

## Combine TPP activity information for COSMOS

```{r, eval = F}
TPP_cosmos_input <- distinct(annoated_ptms_measured, TPP_protein = substrate_genesymbol, sign) %>%
  # bind_rows(distinct(dorothea_measured, TPP_protein=target_genesymbol, sign))%>%
  group_by(TPP_protein) %>%
  summarise(sign_summ = sign(mean(sign)))


TPP_cosmos_input_final <- TPP_cosmos_input %>%
  mutate(sign_summ = ifelse(sign_summ == 0, NaN, sign_summ)) %>%
  bind_rows(data.frame(TPP_protein = TPP_all_scores$gene_name, sign_summ = NaN)) %>%
  distinct(TPP_protein, .keep_all = T)
```

# Save results

Here, the objects necessary for runCOSMOS are put together for different TPP input sets.

## High confidence set

```{r, eval = F}
TPP_cosmos_input_final_highconf <- TPP_cosmos_input_final %>%
  filter(TPP_protein %in% TPP_hits_highcoverage$gene_name)

save(TPP_cosmos_input_final_highconf, viper_trans_top, viper_phospho_top, KSN_TPPtargets_filt,
  file = paste0("C:/Users/mb923573/Documents/Master_thesis/O2_Network_modeling/results/", saveID, "_highconfTPP_viper.RData")
)
```

## TPP F-statistic

```{r, eval = F}
F_stat_hits <- TPP_all_scores %>%
  filter(hit_call == "TPPFstatistic")

TPP_cosmos_input_final_Fstat <- TPP_cosmos_input_final %>%
  filter(TPP_protein %in% F_stat_hits$gene_name)

save(TPP_cosmos_input_final_Fstat, viper_trans_top, viper_phospho_top, KSN_TPPtargets_filt,
  file = paste0("C:/Users/mb923573/Documents/Master_thesis/O2_Network_modeling/results/", saveID, "_TPPFstat_viper.RData")
)
```


## TPP monotony

```{r, eval = F}
monotony_stat_hits <- TPP_all_scores %>%
  filter(hit_call == "TPPmonotony")

TPP_cosmos_input_final_monotony <- TPP_cosmos_input_final %>%
  filter(TPP_protein %in% monotony_stat_hits$gene_name)

save(TPP_cosmos_input_final_monotony, viper_trans_top, viper_phospho_top, KSN_TPPtargets_filt,
  file = paste0("C:/Users/mb923573/Documents/Master_thesis/O2_Network_modeling/results/", saveID, "_TPPmonotony_without30uM_viper.RData")
)
```

```{r}

```
